name: VLSI Design Flow CI

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]

jobs:
  check-structure:
    name: Verify Project Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check directory structure
        run: |
          echo "Checking project structure..."
          test -d design || { echo "Missing: design/"; exit 1; }
          test -d simulation || { echo "Missing: simulation/"; exit 1; }
          test -d characterization || { echo "Missing: characterization/"; exit 1; }
          test -d layout || { echo "Missing: layout/"; exit 1; }
          test -d docs || { echo "Missing: docs/"; exit 1; }
          test -d scripts || { echo "Missing: scripts/"; exit 1; }
          echo "✓ Project structure OK"
      
      - name: Check documentation
        run: |
          echo "Checking documentation..."
          test -f README.md || { echo "Missing: README.md"; exit 1; }
          test -f docs/SETUP.md || { echo "Missing: docs/SETUP.md"; exit 1; }
          test -f docs/DESIGN_SPEC.md || { echo "Missing: docs/DESIGN_SPEC.md"; exit 1; }
          test -f docs/STUDENT_GUIDE.md || { echo "Missing: docs/STUDENT_GUIDE.md"; exit 1; }
          echo "✓ Documentation OK"
      
      - name: Check scripts are executable
        run: |
          echo "Checking script permissions..."
          test -x scripts/setup_env.sh || { echo "Not executable: setup_env.sh"; exit 1; }
          test -x scripts/run_simulations.sh || { echo "Not executable: run_simulations.sh"; exit 1; }
          echo "✓ Script permissions OK"

  lint-scripts:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Run shellcheck
        run: |
          echo "Linting shell scripts..."
          find scripts -name "*.sh" -exec shellcheck {} \; || true
          echo "✓ Shellcheck complete"

  validate-spice:
    name: Validate SPICE Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check SPICE syntax
        run: |
          echo "Checking SPICE files..."
          for f in $(find design/testbenches -name "*.spice" 2>/dev/null); do
            echo "Checking $f..."
            # Basic syntax check (title, .end, etc.)
            grep -q "^\.title" "$f" || echo "Warning: $f missing .title"
            grep -q "^\.end" "$f" || echo "Warning: $f missing .end"
          done
          echo "✓ SPICE syntax check complete"

  validate-markdown:
    name: Validate Markdown Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install markdown linter
        run: npm install -g markdownlint-cli
      
      - name: Lint markdown files
        run: |
          echo "Linting markdown files..."
          markdownlint '**/*.md' --ignore node_modules || true
          echo "✓ Markdown validation complete"

  check-makefile:
    name: Test Makefile Targets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Test make help
        run: make help
      
      - name: Test make verify-structure
        run: make verify-structure
      
      - name: Test make status
        run: make status

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [check-structure, lint-scripts, validate-spice, check-makefile]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "CI Pipeline Summary"
          echo "==================="
          echo "All checks completed!"
          echo ""
          echo "Next steps:"
          echo "1. Review any warnings or failures above"
          echo "2. Ensure all required tools are documented"
          echo "3. Continue with design implementation"
